{% extends 'base.html' %}

{% block title %}AnkiConnect Settings{% endblock %}
{% block header %}AnkiConnect Settings{% endblock %}

{% block body %}

<form method="post">
  {{ form.hidden_tag() }}

  <table class="settingstable">
    {% for f in [
    form.ankiconnect_web_bind_address,
    form.ankiconnect_web_bind_port,
    ]%}
    <tr>
      <td>{{ f.label }}</td>
      <td>{{ f(class="form-control") }}</td>
    </tr>
    {% endfor %}
  </table>

  <div style="margin-top:10px;">
    <button class="btn" onclick="window.alert('TODO'); return false;">Test settings - TODO implement</button>
    <button type="submit" class="btn btn-primary">Save</button>
    <button class="btn" onclick="window.location = '/'; return false;">Cancel</button>
  </div>

</form>

<p>TODO add datatables</p>
<p>delete, edit actions</p>
<p>add new link</p>

<h1>HACKING FORM BUILDER</h1>
<form id="dataMappingForm">
  <label for="noteType">Note Type:</label>
  <select id="noteType">
    <option value="">-- Select Note Type --</option>
    <option value="note_type_A">Note Type A</option>
    <option value="note_type_B">Note Type B</option>
  </select>

  <div id="mappingContainer">
    <!-- Fields will be dynamically inserted here -->
  </div>

</form>

<button id="add_mapping_row" onclick="add_empty_mapping_row(); return false;">+</button>
<button id="getjson" onclick="get_json(); return false;">Get json</button>

<datalist id="mapping_presets">
  {% for x in ['term', 'tags', 'tags["val1", "val2", ...]'] %}
  <option value="{% raw %}{{{% endraw %} {{ x }} {% raw %}}}{% endraw %}">
  {% endfor %}
</datalist>

<datalist id="available_fields" />

<script>

  const noteTypeFields = {
    note_type_A: ["a", "b"],
    note_type_B: ["a", "c", "d"],
  };

  $("#noteType").change(function () {
    const selectedType = $(this).val();
    const mappingContainer = $("#mappingContainer");

    mappingContainer.empty(); // Clear previous fields

    if (!selectedType) return; // Exit if no selection

    const fields = noteTypeFields[selectedType];

    $("#available_fields").empty();
    for (let i = 0; i < fields.length; i++)
      $("#available_fields").append(`<option value="${fields[i]}">`);

    /*
    if (fields.length == 0) return;

    fields.forEach(field => {
      const fieldContainer = $("<div>").addClass("field-container");
      const fieldBox = $("<input>").
            attr({ class: "fieldname", type: "text", list: "available_fields" }).val(field);
      const textBox = $("<input>").
            attr({ class: "fieldval", type: "text", list: "mapping_presets" });
      fieldContainer.append(fieldBox, textBox);
      mappingContainer.append(fieldContainer);
    });
    */

  });

function add_empty_mapping_row() {
  if ($("#noteType").val() == "") {
    console.log("select note type");
    return;
  }
  const mappingContainer = $("#mappingContainer");
  const this_id = "fc_" + ($(".field-container").length + 1);
  const fieldContainer = $(`<div id="${this_id}">`).addClass("field-container");
  const fieldBox = $("<input>").
        attr({ class: "fieldname", type: "text", list: "available_fields" });
  const textBox = $("<input>").
        attr({ class: "fieldval", type: "text", list: "mapping_presets" });
  const del_button = $(`<button onclick="remove_mapping_row('${this_id}'); return false;">-</button>`);
  fieldContainer.append(fieldBox, textBox, del_button);
  mappingContainer.append(fieldContainer);
}

function remove_mapping_row(row_id) {
  console.log(`Removing ${row_id}`);
  $(`#${row_id}`).remove();
}

function get_json() {
  // window.alert('hi');
  let field_mapping = {};
  $(".field-container").each(function() {
    const fieldname = $(this).find(".fieldname").val();
    const fieldval = $(this).find(".fieldval").val();
    field_mapping[fieldname] = fieldval;
  });
  console.log(JSON.stringify(field_mapping, null, 2));
}
</script>

{% endblock %}
