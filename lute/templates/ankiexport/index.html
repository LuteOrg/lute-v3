{% extends 'base.html' %}

{% block title %}AnkiConnect{% endblock %}
{% block header %}AnkiConnect{% endblock %}

{% block body %}

<form method="post">
  {{ form.hidden_tag() }}
  <p>
    {{ form.ankiconnect_url.label }}:
    {{ form.ankiconnect_url(class="form-control") }}
    <button class="btn" onclick="test_ankiconnect_connection(); return false;">Test</button>
  </p>
  <div style="margin-top:10px;">
    <button type="submit" class="btn btn-primary">Save</button>
    <button class="btn" onclick="window.location = '/'; return false;">Cancel</button>
  </div>
</form>

<br />
<table id="export_specs" class="display" width="100%"></table>
<p><a href="/ankiexport/spec/new">Create new export specification</a></p>

<script>

  $( document ).ready(function() {
    new DataTable('#export_specs', {
      columns: [
        { title: 'Export_id', data: 'id', visible: false },
        { title: 'Export name', render: render_export_name },
        { title: 'Specification', width: '40%', render: render_export_spec },
        { title: 'Mapping', width: '40%', render: render_mapping },
        { title: 'Active', data: 'active' }
      ],
      data: {{ export_specs_json | tojson | safe }}
    });

  });

  let render_export_name = function( data, type, row, meta ) {
    const eid = row['id'];
    const ename = row['export_name'];
    const url = `/ankiexport/spec/edit/${eid}`;
    const a = `<a href="${url}">${ename}</a>`;
    return a;
  };

  let render_export_spec = function( data, type, row, meta ) {
    let c = `${row['criteria']}`.trim();
    if (c == "")
      c = "(no criteria)";
    else
      c = `<code>${c}</code>`;
    const crit = `Criteria: ${c}`;
    const dn = `Deck: ${row['deck_name']}`;
    const nt = `Note type: ${row['note_type']}`;
    const ret = [crit, dn, nt].map(el => `<p>${el}</p>`);
    return ret.join("\n");
  };

  let render_mapping = function( data, type, row, meta ) {
    let fmjson = '';
    try {
      let tmp = JSON.parse(row['field_mapping']);
      let fmjson_array = [];
      for (const [fname, mapval] of Object.entries(tmp)) {
        const p = `<code>${fname}</code> = <code>${mapval}</code>`
        fmjson_array.push(p);
      }
      fmjson = `${fmjson_array.join('<br />')}`;
    }
    catch {
      fmjson = '(error, unable to parse)'
    }
    return fmjson;
  };


  function test_ankiconnect_connection() {
    const ac_url = $("#ankiconnect_url").val().trim();
    if (ac_url == "") {
      alert("Please specify the AnkiConnect URL.");
      $("#ankiconnect_url").focus();
      return;
    }
    LuteAnki.get_anki_specs(ac_url)
      .then(() => alert(`Connected successfully to AnkiConnect at ${ac_url}.`))
      .catch(error => alert(error));
  }

</script>

{% endblock %}
