{% extends 'base.html' %}

{% block title %}AnkiConnect Settings{% endblock %}
{% block header %}AnkiConnect Settings{% endblock %}

{% block body %}

<form method="post">
  {{ form.hidden_tag() }}

  <table class="settingstable">
    {% for f in [
    form.ankiconnect_web_bind_address,
    form.ankiconnect_web_bind_port,
    ]%}
    <tr>
      <td>{{ f.label }}</td>
      <td>{{ f(class="form-control") }}</td>
    </tr>
    {% endfor %}
  </table>

  <div style="margin-top:10px;">
    <button class="btn" onclick="window.alert('TODO'); return false;">Test settings - TODO implement</button>
    <button type="submit" class="btn btn-primary">Save</button>
    <button class="btn" onclick="window.location = '/'; return false;">Cancel</button>
  </div>

</form>

<p>TODO add datatables</p>
<p>delete, edit actions</p>
<p>add new link</p>

<style>
  .arrow_only_dropdown {
    appearance: none; /* Hides default styling */
    width: 20px; /* Only show the dropdown arrow */
    overflow: hidden;
    border: none;
    background: none;
    cursor: pointer;
  }
</style>

<h1>HACKING FORM BUILDER</h1>

<form id="dataMappingForm">
  <label for="noteType">Note Type:</label>
  <select id="noteType">
    <option value="">-- Select Note Type --</option>
    <option value="note_type_A">Note Type A</option>
    <option value="note_type_B">Note Type B</option>
  </select>

  <div id="mappingContainer">
    <!-- Fields will be dynamically inserted here -->
  </div>

</form>

<button id="add_mapping_row" onclick="add_empty_mapping_row(); return false;">+</button>
<button id="getjson" onclick="get_json(); return false;">Get json</button>

<script>

  // Prevent Return from submitting the form.
  $("dataMappingForm").bind("keypress", function (e) {
    if (e.keyCode == 13) {
      return false;
    }
  });

  const noteTypeFields = {
    note_type_A: ["a", "b"],
    note_type_B: ["a", "c", "d"],
  };

  $("#noteType").change(function () {
    const selectedType = $(this).val();
    if (!selectedType) return;

    const fields = noteTypeFields[selectedType];
    $("#available_fields").empty();
    for (let i = 0; i < fields.length; i++)
      $("#available_fields").append(`<option value="${fields[i]}">`);

    $(".field-container").each(function() {
      const fieldname_input = $(this).find(".fieldname")
      const fieldname = fieldname_input.val();
      if (!fields.includes(fieldname)) {
        fieldname_input.css("border-color", "red");
      }
    });

    remove_empty_mapping_rows();

    const mappingContainer = $("#mappingContainer");

    if ($(".field-container").length == 0) {
      fields.forEach(f => add_empty_mapping_row(f));
    }
    else {
      $(".field_list_dropdown").each(function() {
        add_fields($(this), fields);
      });
    }

  });

function add_fields(field_select, field_list) {
  field_select.empty();
  field_select.append(new Option("\u25BE", ""));
  field_list.forEach(f => {
    field_select.append(new Option(f, f));
  });
}

function field_box_changed(field_box) {
  const selectedType = $("#noteType").val();
  if (!selectedType) return;
  const available_fields = noteTypeFields[selectedType];
  const field_name = field_box.val();
  const color = available_fields.includes(field_name) ? "" : "red";
  field_box.css("border-color", color);
}

function add_empty_mapping_row(field_name = null) {
  const selectedType = $("#noteType").val();
  if (!selectedType) {
    console.log("select note type");
    return;
  }

  const mappingContainer = $("#mappingContainer");
  const rowid = $(".field-container").length + 1;
  const this_id = `fc_${rowid}`;
  const fieldContainer = $(`<div id="${this_id}">`).addClass("field-container");
  const f_id = `f_${rowid}`;
  const fieldBox = $(`<input id="${f_id}" type="text" class="fieldname">`);
  if (field_name)
    fieldBox.val(field_name);

  const fields = noteTypeFields[selectedType];
  const fieldOpts = $(`<select class="field_list_dropdown arrow_only_dropdown" />`);
  add_fields(fieldOpts, fields);

  fieldOpts.on('change', function() {
    const v = $(this).val() ?? "";
    if (v == "")
      return;
    fieldBox.val(v);
    field_box_changed(fieldBox);
    this.selectedIndex = 0; // Reset to down arrow
    this.blur();
  });

  // Bind the change event to remove the red border color
  fieldBox.on('change', function() {
    field_box_changed($(this));
  });

  const textBox = $(`<input class="fieldval" type="text">`);
  const valOpts = $(`<select class="val_list_dropdown arrow_only_dropdown" />`);
  valOpts.append(new Option("\u25BE", ""));
  [ 'text', 'tags' ].forEach(v => {
    const optval = `{% raw %}{{{% endraw %} ${v} {% raw %}}}{% endraw %}`;
    valOpts.append(new Option(optval, optval));
  });

  valOpts.on('change', function() {
    const v = $(this).val() ?? "";
    if (v == "")
      return;
    textBox.val(v);
    this.selectedIndex = 0; // Reset to down arrow
    this.blur();
  });

  const del_button = $(`<button type="button" onclick="remove_mapping_row('${this_id}'); return false;">-</button>`);
  fieldContainer.append(fieldBox, fieldOpts, textBox, valOpts, del_button);
  mappingContainer.append(fieldContainer);
}

function remove_empty_mapping_rows() {
  $(".field-container").each(function() {
    if ($(this).find(".fieldval").val() === "") {
      $(this).remove(); // Remove the container if the fieldval is empty
    }
  });
}

function remove_mapping_row(row_id) {
  $(`#${row_id}`).remove();
}

function get_json() {
  remove_empty_mapping_rows();
  let field_mapping = {};
  $(".field-container").each(function() {
    const fieldname = $(this).find(".fieldname").val();
    const fieldval = $(this).find(".fieldval").val();
    field_mapping[fieldname] = fieldval;
  });
  console.log(JSON.stringify(field_mapping, null, 2));
}
</script>

{% endblock %}
