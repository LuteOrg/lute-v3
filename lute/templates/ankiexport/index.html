{% extends 'base.html' %}

{% block title %}AnkiConnect{% endblock %}
{% block header %}AnkiConnect{% endblock %}

{% block body %}

<form method="post">
  {{ form.hidden_tag() }}
  <p>
    {{ form.ankiconnect_url.label }}:
    {{ form.ankiconnect_url(class="form-control") }}
    <button class="btn" onclick="test_ankiconnect_connection(); return false;">Test</button>
  </p>
  <div style="margin-top:10px;">
    <button type="submit" class="btn btn-primary">Save</button>
    <button class="btn" onclick="window.location = '/'; return false;">Cancel</button>
  </div>

</form>

<table id="export_specs">
  <thead>
    <tr>
      <th>ID</th>
      <th>Export Name</th>
      <th>Criteria</th>
      <th>Deck Name</th>
      <th>Note Type</th>
      <th>Field Mapping</th>
      <th>Active</th>
    </tr>
  </thead>
  <tbody>
    {% for spec in export_specs %}
    <tr>
      <td>{{ spec.id }}</td>
      <td>{{ spec.export_name }}</td>
      <td>{{ spec.criteria }}</td>
      <td>{{ spec.deck_name }}</td>
      <td>{{ spec.note_type }}</td>
      <td>{{ spec.field_mapping }}</td>
      <td>{{ "Yes" if spec.active else "No" }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
  
<p>TODO add datatables</p>
<p>delete, edit actions</p>
<p>add new link</p>

<script>

  function test_ankiconnect_connection() {
    const ac_url = $("#ankiconnect_url").val().trim();
    if (ac_url == "") {
      alert("Please specify the AnkiConnect URL.");
      $("#ankiconnect_url").focus();
      return;
    }
    LuteAnki.get_anki_specs(ac_url)
      .then(() => alert(`Connected successfully to AnkiConnect at ${ac_url}.`))
      .catch(error => alert(error));
  }

  $( document ).ready(function() {
    const dt = new DataTable('#export_specs');
  });
  
</script>

<style>
  .arrow_only_dropdown {
    appearance: none; /* Hides default styling */
    width: 20px; /* Only show the dropdown arrow */
    overflow: hidden;
    border: none;
    background: none;
    cursor: pointer;
  }
</style>

<h1>HACKING FORM BUILDER</h1>

<form id="dataMappingForm">
  <label for="noteType">Note Type:</label>
  <select id="noteType">
    <option value="">-- Select Note Type --</option>
    <option value="note_type_A">Note Type A</option>
    <option value="note_type_B">Note Type B</option>
  </select>

  <div id="mappingContainer">
    <!-- Fields will be dynamically inserted here -->
  </div>

</form>

<button id="add_mapping_row" onclick="add_empty_mapping_row(); return false;">&nbsp;+&nbsp;</button>
<button id="getjson" onclick="get_json(); return false;">Get json</button>

<script>

  // Prevent Return from submitting the form.
  $("#dataMappingForm").bind("keypress", function (e) {
    if (e.keyCode == 13) {
      return false;
    }
  });

  const noteTypeFields = {
    note_type_A: ["a", "b"],
    note_type_B: ["a", "c", "d"],
  };

  $("#noteType").change(function () {
    const selectedType = $(this).val();
    if (!selectedType) return;

    const fields = noteTypeFields[selectedType];
    $("#available_fields").empty();
    for (let i = 0; i < fields.length; i++)
      $("#available_fields").append(`<option value="${fields[i]}">`);

    $(".field-container").each(function() {
      const fieldname_input = $(this).find(".fieldname")
      const fieldname = fieldname_input.val();
      if (!fields.includes(fieldname)) {
        fieldname_input.css("border-color", "red");
      }
    });

    remove_empty_mapping_rows();

    const mappingContainer = $("#mappingContainer");

    if ($(".field-container").length == 0) {
      fields.forEach(f => add_empty_mapping_row(f));
    }
    else {
      $(".field_dropdown").each(function() {
        add_options($(this), fields);
      });
    }

  });

function add_options(field_select, opts_list) {
  field_select.empty();
  field_select.append(new Option("\u25BE", ""));
  opts_list.forEach(f => {
    field_select.append(new Option(f, f));
  });
}

function field_box_changed(field_box) {
  const selectedType = $("#noteType").val();
  if (!selectedType) return;
  const available_fields = noteTypeFields[selectedType];
  const field_name = field_box.val();
  const color = available_fields.includes(field_name) ? "" : "red";
  field_box.css("border-color", color);
}

function add_empty_mapping_row(field_name = null, mapping_val = null) {
  const selectedType = $("#noteType").val();
  /*
  if (!selectedType) {
    console.log("select note type");
    return;
    }
  */

  const mappingContainer = $("#mappingContainer");
  const rowid = $(".field-container").length + 1;
  const this_id = `fc_${rowid}`;
  const fieldContainer = $(`<div id="${this_id}">`).addClass("field-container");

  const fieldBox = $(`<input type="text" class="fieldname">`);
  if (field_name)
    fieldBox.val(field_name);
  fieldBox.on('change', function() {
    field_box_changed($(this));
  });

  const textBox = $(`<input class="fieldval" type="text">`);
  if (mapping_val)
    textBox.val(mapping_val);

  function _create_dropdown(className, options, onChange) {
    const select = $(`<select class="${className} arrow_only_dropdown" />`);
    add_options(select, options);
    select.on("change", function () {
      const v = $(this).val() ?? "";
      if (v !== "")
        onChange(v);
      $(this).val("").blur(); // Reset to down arrow
    });
    return select;
  }

  const fields = noteTypeFields[selectedType] ?? [];
  const fieldOpts = _create_dropdown("field_dropdown", fields, (v) => {
    fieldBox.val(v);
    field_box_changed(fieldBox);
  });

  const vos = ["text", "tags"].map((v) => `{ ${v} }`);
  const valOpts = _create_dropdown("mapping_dropdown", vos, (v) => {
    textBox.val(v);
  });
  
  const del_button = $(`<button type="button">&nbsp;-&nbsp;</button>`).data("row-id", this_id);
  del_button.on("click", function () { remove_mapping_row($(this).data("row-id")); });

  fieldContainer.append(fieldBox, fieldOpts, textBox, valOpts, del_button);
  mappingContainer.append(fieldContainer);
}

function remove_empty_mapping_rows() {
  $(".field-container").filter(function () {
    return !$(this).find(".fieldval").val().trim();
  }).remove();
}

function remove_mapping_row(row_id) {
  $(`#${row_id}`).remove();
}

function get_json() {
  remove_empty_mapping_rows();
  let field_mapping = {};
  $(".field-container").each(function() {
    const c = $(this);
    const fieldname = c.find(".fieldname").val().trim();
    const fieldval = c.find(".fieldval").val().trim();
    if (fieldval != "")
      field_mapping[fieldname] = fieldval;
  });
  console.log(JSON.stringify(field_mapping, null, 2));
}
</script>

<script>

function load_stuff() {
  $("#noteType").val("preload");
  const fd = { "blah": "blah map", "b2": "{ b2map }" };
  Object.entries(fd).forEach(([key, value]) => {
    console.log(key, value);
    add_empty_mapping_row(key, value);
  });
}

load_stuff();
</script>

{% endblock %}
